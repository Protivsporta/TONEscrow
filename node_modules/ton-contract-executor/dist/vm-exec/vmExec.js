"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.vm_exec = void 0;
const VmExec = require('../vm-exec/vm-exec');
let instance = null;
let isInitializing = false;
let waiters = [];
async function getInstance() {
    if (instance) {
        return instance;
    }
    if (isInitializing) {
        return new Promise(resolve => waiters.push(resolve));
    }
    isInitializing = true;
    instance = await VmExec();
    // Notify all waiters
    waiters.map(w => w(instance));
    return instance;
}
async function vm_exec(config) {
    let vmInstance = await getInstance();
    let bytes = vmInstance.intArrayFromString(JSON.stringify(config));
    let ref = vmInstance.allocate(bytes, VmExec.ALLOC_NORMAL);
    let res = vmInstance._vm_exec(bytes.length - 1, ref);
    let out = vmInstance.UTF8ToString(res);
    vmInstance._free(ref);
    vmInstance._free(res);
    return JSON.parse(out);
}
exports.vm_exec = vm_exec;
